'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};const stripe_1=__importDefault(require('stripe'));const product_service_1=require('../service/product_service');const express_1=__importDefault(require('express'));const validate_order_1=require('../validation/validate_order');const line_item_1=require('../model/line_item');const shipping_1=require('../model/shipping');let router=express_1.default.Router();const DOMAIN=process.env.DOMAIN;const api_key=process.env.STRIPE_KEY;if(!api_key){throw console.error('Stripe API key missing!');}const stripe=new stripe_1.default(api_key,{apiVersion:'2020-08-27'});router.post('/create-session',(req,res,next)=>__awaiter(void 0,void 0,void 0,function*(){let order=req.body;try{validate_order_1.validate_new_order(order);}catch(err){res.status(422).json({error:err.message});}try{let line_items=[];for(let item of order.items){let product=product_service_1.getProduct(item.id);if(product){line_items.push(new line_item_1.Line_item(product.name,product.description,product.price.value,product.images,{size:item.size,color:product.primary_color.name}));}}let shipping=new shipping_1.Shipping(order.shipping_option);line_items.push(new line_item_1.Line_item('Shipping',shipping.description,shipping.cost));const session=yield stripe.checkout.sessions.create({payment_method_types:['card','eps','sofort'],shipping_address_collection:shipping.shippingAddressCollection,line_items:line_items,mode:'payment',success_url:DOMAIN+'/success',cancel_url:DOMAIN+'/cancel'});res.json({id:session.id});}catch(err){next(err);}}));module.exports=router;